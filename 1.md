flowchart TD
    subgraph Genesys Cloud
        A1(Новая email-интеракция)
        A2(Подписка через PureCloud.subscribe)
    end

    subgraph Dynamics 365
        D1[Создание email-записи]
        D2[Обновление статуса письма]
        D3[Прикрепление вложений]
        D4[Открытие формы письма]
    end

    subgraph AWS Proxy (Lambda)
        P1[Запрос вложений по contentUri]
        P2[Преобразование в base64]
        P3[Ответ клиенту с base64-данными]
    end

    A1 --> A2
    A2 --> B1{isEmail + Inbound?}
    B1 -- да --> B2[transferEmailToDynamics]

    B2 --> D1
    D1 --> D2
    D2 --> D3

    D3 --> P1
    P1 --> P2
    P2 --> P3
    P3 --> D3

    D3 --> D4
