# Genesys Embeddable Framework → Dynamics 365 Email Integration

This document describes the data flow and core architecture of the integration between Genesys Cloud's Embeddable Framework and Microsoft Dynamics 365. The integration is implemented using an iframe inside Dynamics and uses an AWS Lambda proxy for secure email attachment retrieval.

## Overview

- **Genesys Embeddable Framework** is embedded into **Dynamics 365** as an iframe.
- When a new **email interaction** arrives in Genesys, it triggers the data flow.
- The email and its metadata (participants, subject, body, etc.) are transferred to **Dynamics CRM**.
- Email attachments are downloaded through a secure **AWS Lambda proxy**, base64 encoded, and added to the Dynamics email record.
- Upon successful creation, the email form is opened in Dynamics UI.

## Data Flow Diagram (Mermaid)

```mermaid
flowchart TD
  subgraph Browser
    A[Genesys Embedded Client (iframe)]
  end

  subgraph Genesys Cloud
    B[PureCloud API]
  end

  subgraph Dynamics 365
    C[Microsoft.CIFramework.createRecord]
    D[Microsoft.CIFramework.updateRecord]
    E[Microsoft.CIFramework.openForm]
  end

  subgraph AWS_Proxy
    F[AWS Lambda Proxy Function]
  end

  A -->|Inbound Email Event| B
  B -->|Fetch Email Message| A
  A -->|Convert Email| C
  C --> D
  D --> E
  A -->|Get Attachments via contentUri| F
  F -->|Base64 encoded file| A
  A -->|Attach to email| C

```

## Description of Key Steps

### 1. Initialization

- `handleInitialSetup` loads the PureCloud API and Microsoft CIF.
- Subscribes to email interactions using Genesys' `PureCloud.subscribe`.

### 2. Email Processing

- For each incoming **inbound email**:
  - Converts metadata (sender, recipients, subject, body, time) into Dynamics format.
  - Creates a new `email` record in Dynamics using `Microsoft.CIFramework.createRecord`.
  - Updates status with `Microsoft.CIFramework.updateRecord`.
  - Opens the form with `Microsoft.CIFramework.openForm`.

### 3. Attachment Handling

- Each attachment’s `contentUri` is securely proxied through an **AWS Lambda**.
- The Lambda follows redirects, fetches the file, and returns it as base64.
- The frontend converts and uploads it to Dynamics as `activitymimeattachment`.

### 4. Final Steps

- If everything succeeds, the email is shown in Dynamics.
- If it fails, Genesys reroutes the interaction to a fallback queue.

## Technologies Used

- **Genesys Embeddable Framework (PureCloud API)**
- **Microsoft Dynamics 365 CRM JavaScript API (CIFramework)**
- **AWS Lambda (Node.js Proxy Function)**

---

© 2025 — Integration Author: You
