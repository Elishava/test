# Genesys to Dynamics Email Integration Flow

## Overview

When an inbound email is received in Genesys Cloud, it is automatically transferred to Dynamics 365 as an Email entity with attachments. This integration uses the Genesys Embeddable Framework (within Dynamics via iframe) and AWS Lambda as a proxy for file fetching.

---

## Flow Diagram

```mermaid
flowchart TD
    subgraph Genesys Cloud
        A1(Новая email-интеракция)
        A2(Подписка через PureCloud.subscribe)
    end

    subgraph Dynamics 365
        D1[Создание email-записи]
        D2[Обновление статуса письма]
        D3[Прикрепление вложений]
        D4[Открытие формы письма]
    end

    subgraph AWS Proxy (Lambda)
        P1[Запрос вложений по contentUri]
        P2[Преобразование в base64]
        P3[Ответ клиенту с base64-данными]
    end

    A1 --> A2
    A2 --> B1{isEmail + Inbound?}
    B1 -- да --> B2[transferEmailToDynamics]

    B2 --> D1
    D1 --> D2
    D2 --> D3

    D3 --> P1
    P1 --> P2
    P2 --> P3
    P3 --> D3

    D3 --> D4
```

---

## Step-by-step

### 1. Subscription
- Subscribed to inbound email interactions using `PureCloud.subscribe`.

### 2. Email Creation in Dynamics
- Transforms Genesys email preview into Dynamics format.
- Calls `createRecord` to create a new email.

### 3. Update Status
- Marks email as received using `updateRecord`.

### 4. Attachment Upload
- Fetches each attachment from `contentUri` via AWS Proxy.
- Converts content to base64 and uploads via `createRecord`.

### 5. Form Opening
- Opens the newly created email record in a form view.

### 6. Success / Failure Handling
- Success → Ends interaction.
- Failure → Blind transfer to backup queue.

---

## AWS Proxy (Lambda)

Handles authenticated file fetches from external URIs:

- Accepts `url` and `authorization` headers.
- Follows redirects.
- Returns base64-encoded file content with correct headers.
